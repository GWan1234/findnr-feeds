#!/usr/bin/env ucode
'use strict';

import { stdin, stdout, popen, open } from 'fs';
import dispatch from 'luci.dispatcher';
import request from 'luci.http';
import { load as i18n_load, translate as _ } from 'luci.i18n';

// åˆå§‹åŒ– i18n
i18n_load('simple2fa');

// æ—¥å¿—å‡½æ•°
function log(msg) {
    try {
        let f = open('/tmp/simple2fa.log', 'a');
        if (f) {
            f.write(`${new Date().toISOString()} - ${msg}\n`);
            f.close();
        }
    } catch (e) { }
}

log("Simple2FA CGI started");

// åˆå§‹åŒ–å˜é‡
const input_bufsize = 4096;
let content_len = +getenv('CONTENT_LENGTH') || 0;
let buffer = null;
let buffer_pos = 0;
let response_buffer = "";
let is_login_page = false;

// Helper: Trim string
function trim_str(s) {
    return s ? replace(s, /^\s+|\s+$/g, "") : "";
}

// ==========================================================
// ðŸ›¡ï¸ 2FA æ‹¦æˆªæ ¸å¿ƒé€»è¾‘ (å¼€å§‹)
// ==========================================================

try {
    // 1. æ‹¦æˆª POST ç™»å½•è¯·æ±‚
    if (getenv('REQUEST_METHOD') == 'POST' && content_len > 0 && content_len < 10240) {
        buffer = stdin.read(content_len);

        let user_match = match(buffer, /luci_username=([^&]+)/);
        if (user_match && user_match[1] == 'root') {
            let p = popen('uci -q get simple2fa.global.enabled');
            let enabled = trim_str(p.read('all'));
            p.close();

            if (enabled == '1') {
                p = popen('uci -q get simple2fa.global.secret');
                let secret = trim_str(p.read('all'));
                p.close();

                if (secret) {
                    let token_match = match(buffer, /token=([^&]*)/);
                    let token = token_match ? token_match[1] : "";

                    p = popen(`oathtool -b --totp -d 6 '${secret}'`);
                    let correct_code = trim_str(p.read('all'));
                    p.close();

                    if (correct_code && token != correct_code) {
                        log(`2FA Blocked: user=root, input=${token}, correct=${correct_code}`);
                        print("Status: 302 Found\r\n");
                        print("Location: /cgi-bin/luci?simple2fa_err=1\r\n\r\n");
                        exit(0);
                    }
                    log(`2FA Success: user=root`);
                }
            }
        }
    }

    // 2. æ£€æµ‹æ˜¯å¦æ˜¯ç™»å½•é¡µé¢ (GET è¯·æ±‚ä¸”æ—  stok)
    let query_string = getenv('QUERY_STRING') ?? "";
    if (getenv('REQUEST_METHOD') == 'GET' && index(query_string, 'stok=') == -1) {
        is_login_page = true;
        log(`Login page detected: QUERY_STRING=${query_string}`);
    }
} catch (e) {
    log(`Logic Error: ${e}`);
}

// ==========================================================
// ðŸ›¡ï¸ 2FA æ‹¦æˆªæ ¸å¿ƒé€»è¾‘ (ç»“æŸ)
// ==========================================================

// é€šç”¨ 2FA è¾“å…¥æ¡†æ³¨å…¥ JS
const simple2fa_inject_js = `
<script>
(function() {
    function injectTokenField() {
        var passInput = document.querySelector('input[type="password"][name="luci_password"]');
        if (!passInput) {
            setTimeout(injectTokenField, 200);
            return;
        }
        
        if (document.querySelector('input[name="token"]')) return;
        
        var tokenInput = document.createElement('input');
        tokenInput.type = 'text';
        tokenInput.name = 'token';
        tokenInput.placeholder = '${_("2FA Token (Leave empty if not enabled)")}';
        tokenInput.autocomplete = 'off';
        tokenInput.className = passInput.className;
        tokenInput.style.cssText = passInput.style.cssText;
        tokenInput.style.marginTop = '10px';
        
        var target = passInput;
        var parent = passInput.parentElement;
        
        if (parent && parent.classList.contains('input-group')) {
            target = parent;
        }
        
        var wrapper = document.createElement('div');
        wrapper.className = 'luci-2fa-wrapper';
        wrapper.style.marginTop = '10px';
        wrapper.appendChild(tokenInput);
        
        target.parentNode.insertBefore(wrapper, target.nextSibling);
        
        if (window.location.search.indexOf('simple2fa_err=1') !== -1) {
            var errDiv = document.createElement('div');
            errDiv.style.cssText = 'color: #d9534f; background: #f2dede; border: 1px solid #ebccd1; padding: 10px; margin-bottom: 15px; border-radius: 4px; text-align: center;';
            errDiv.innerText = '${_("Invalid 2FA token, please try again")}';
            
            var form = document.querySelector('form');
            if (form) form.insertBefore(errDiv, form.firstChild);
            
            if (history.replaceState) {
                var clean_url = window.location.protocol + "//" + window.location.host + window.location.pathname;
                history.replaceState(null, '', clean_url);
            }
        }
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', injectTokenField);
    } else {
        injectTokenField();
    }
})();
</script>
`;

function read(len) {
    if (buffer) {
        if (buffer_pos >= length(buffer)) return null;
        let chunk_len = min(length(buffer) - buffer_pos, len ?? input_bufsize);
        let chunk = substr(buffer, buffer_pos, chunk_len);
        buffer_pos += chunk_len;
        return chunk;
    }
    return stdin.read(len ?? input_bufsize);
}

function write(data) {
    if (is_login_page) {
        response_buffer += data;
        return length(data);
    }
    return stdout.write(data);
}

// åˆ†å‘è¯·æ±‚
try {
    let req = request(getenv(), read, write);
    dispatch(req);
    req.close();
} catch (e) {
    log(`Dispatch Error: ${e}`);
}

// æ³¨å…¥ JS
if (is_login_page && length(response_buffer) > 0) {
    let inject_pos = index(response_buffer, '</body>');
    if (inject_pos == -1) inject_pos = index(response_buffer, '</html>');

    if (inject_pos != -1) {
        stdout.write(substr(response_buffer, 0, inject_pos));
        stdout.write(simple2fa_inject_js);
        stdout.write(substr(response_buffer, inject_pos));
    } else {
        stdout.write(response_buffer);
        stdout.write(simple2fa_inject_js);
    }
}