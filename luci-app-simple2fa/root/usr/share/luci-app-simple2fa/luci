#!/usr/bin/env ucode
'use strict';

// Simple2FA Debug Build - ucode CGI
// åŸºäºåŸå§‹ lede CGI æ ¼å¼ï¼Œæ·»åŠ  2FA æ‹¦æˆªé€»è¾‘
// æ ‡è®°: Simple2FA-Debug

import { stdin, stdout, popen } from 'fs';
import dispatch from 'luci.dispatcher';
import request from 'luci.http';

// æ—¥å¿—å‡½æ•° (ä½¿ç”¨ popen è€Œé system)
function log(msg) {
    let p = popen('logger -t simple2fa "[CGI] ' + replace(msg + '', /"/g, '\\"') + '"');
    if (p) p.close();
}

log('========== CGI å¯åŠ¨ ==========');

// åˆå§‹åŒ–å˜é‡
const input_bufsize = 4096;
let content_len = +getenv('CONTENT_LENGTH') || 0;
let method = getenv('REQUEST_METHOD') || 'UNKNOWN';
let uri = getenv('REQUEST_URI') || '';
let buffer = null;
let buffer_pos = 0;

log('è¯·æ±‚: METHOD=' + method + ', LEN=' + content_len + ', URI=' + uri);

// Helper: å»é™¤å­—ç¬¦ä¸²ä¸¤ç«¯ç©ºç™½
function trim(s) {
    return s ? replace(s, /^\s+|\s+$/g, '') : '';
}

// Helper: æ‰§è¡Œå‘½ä»¤å¹¶è·å–è¾“å‡º
function exec_cmd(cmd) {
    let p = popen(cmd);
    if (!p) return '';
    let result = p.read('all') || '';
    p.close();
    return trim(result);
}

// ==========================================================
// ğŸ›¡ï¸ 2FA æ‹¦æˆªæ ¸å¿ƒé€»è¾‘
// ==========================================================

// åªåœ¨ç™»å½• POST è¯·æ±‚æ—¶è¿›è¡Œæ£€æŸ¥
if (method == 'POST' && content_len > 0 && content_len < 10240) {
    // æ£€æŸ¥æ˜¯å¦æ˜¯ç™»å½•ç›¸å…³ URI (åŒ¹é…æ ¹è·¯å¾„å’Œ admin è·¯å¾„)
    if (match(uri, /^\/cgi-bin\/luci\/?/) || match(uri, /^\/cgi-bin\/luci\/admin\/?/)) {
        log('æ£€æµ‹åˆ°å¯èƒ½çš„ç™»å½•è¯·æ±‚ï¼Œè¯»å– POST æ•°æ®');
        buffer = stdin.read(content_len);
        
        if (buffer && match(buffer, /luci_username=/)) {
            log('ç¡®è®¤æ˜¯ç™»å½•è¯·æ±‚ (åŒ…å« luci_username)');
            
            // è§£æç”¨æˆ·å
            let user_match = match(buffer, /luci_username=([^&]+)/);
            let username = user_match ? user_match[1] : '';
            
            // è§£æ TOTP éªŒè¯ç  (å­—æ®µå: totp_code)
            let totp_match = match(buffer, /totp_code=([^&]*)/);
            let totp_code = totp_match ? totp_match[1] : '';
            
            log('ç™»å½•ç”¨æˆ·: ' + username + ', TOTPè¾“å…¥: ' + totp_code);
            
            if (username == 'root') {
                // æ£€æŸ¥ 2FA æ˜¯å¦å¯ç”¨
                let enabled = exec_cmd('uci -q get simple2fa.global.enabled');
                log('2FA å¯ç”¨çŠ¶æ€: ' + enabled);
                
                if (enabled == '1') {
                    let secret = exec_cmd('uci -q get simple2fa.global.secret');
                    
                    if (secret && length(secret) > 0) {
                        log('å¯†é’¥å·²é…ç½®ï¼Œé•¿åº¦: ' + length(secret));
                        
                        // è®¡ç®—æ­£ç¡®çš„ TOTP
                        let correct = exec_cmd("oathtool -b --totp -d 6 '" + secret + "'");
                        log('TOTPéªŒè¯: è¾“å…¥=' + totp_code + ', æ­£ç¡®=' + correct);
                        
                        if (correct && length(correct) > 0 && totp_code != correct) {
                            log('âŒ éªŒè¯å¤±è´¥ -> é‡å®šå‘åˆ°ç™»å½•é¡µ');
                            print('Status: 302 Found\r\n');
                            print('Location: /cgi-bin/luci/?simple2fa_err=1\r\n\r\n');
                            exit(0);
                        } else if (totp_code == correct) {
                            log('âœ… éªŒè¯é€šè¿‡');
                        } else {
                            log('âš ï¸ oathtool è¿”å›ç©ºå€¼ï¼Œè·³è¿‡éªŒè¯');
                        }
                    } else {
                        log('âš ï¸ å¯†é’¥æœªé…ç½®ï¼Œè·³è¿‡éªŒè¯');
                    }
                } else {
                    log('2FA æœªå¯ç”¨ (enabled=' + enabled + ')ï¼Œè·³è¿‡éªŒè¯');
                }
            } else {
                log('é root ç”¨æˆ·ç™»å½•ï¼Œè·³è¿‡ 2FA');
            }
        } else {
            log('POST æ•°æ®ä¸åŒ…å« luci_usernameï¼Œéç™»å½•è¯·æ±‚');
        }
    } else {
        log('URI ä¸åŒ¹é…ç™»å½•è·¯å¾„ï¼Œè·³è¿‡æ£€æŸ¥');
    }
}

// ==========================================================
// åŒ…è£… read å‡½æ•°ï¼šå¦‚æœç¼“å­˜äº†æ•°æ®ï¼Œä»ç¼“å­˜è¯»å–
// ==========================================================

function read(len) {
    if (buffer) {
        // ä»ç¼“å­˜è¯»å– (ç™»å½•è¯·æ±‚å·²ç»è¯»å–è¿‡)
        if (buffer_pos >= length(buffer)) return null;
        
        let chunk_len = min(length(buffer) - buffer_pos, len ?? input_bufsize);
        let chunk = substr(buffer, buffer_pos, chunk_len);
        buffer_pos += chunk_len;
        return chunk;
    } else {
        // åŸå§‹æµå¼è¯»å–
        if (content_len <= 0) {
            stdin.close();
            return null;
        }
        
        let chunk = stdin.read(min(content_len, len ?? input_bufsize, input_bufsize));
        if (chunk == null) {
            content_len = 0;
            stdin.close();
        } else {
            content_len -= length(chunk);
        }
        return chunk;
    }
}

function write(data) {
    return stdout.write(data);
}

// ==========================================================
// åˆ†å‘è¯·æ±‚åˆ° LuCI
// ==========================================================

log('è°ƒç”¨ LuCI dispatcher');

let req = request(getenv(), read, write);
dispatch(req);
req.close();

log('========== CGI ç»“æŸ ==========');